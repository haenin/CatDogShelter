<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.backoven.catdogshelter.domain.missing.query.mapper.MissingPostQueryMapper">

    <!--게시글 서치 목록 조회 -->
    <select id="selectMissingPostSearch" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT
        p.id              AS id,        -- 번호
        p.title           AS title,     -- 제목
        p.created_at      AS createdAt, -- 작성일
        p.view            AS view,      -- 조회수
        r.name      AS userRating, -- 사용자 등급
        COALESCE(u.user_name, sh.ceo_name) AS userName, -- 작성자 이름
        IFNULL(COUNT(mpl.id), 0) AS likeCount ,          -- 추천수
        p.status
        FROM missingPost p
        LEFT JOIN user u ON p.user_id = u.user_id
        LEFT JOIN shelter_head sh ON p.head_id = sh.head_id
        LEFT JOIN missingPostLiked mpl ON p.id = mpl.post_id
        LEFT JOIN rating r ON u.rating_id = r.id
        WHERE p.is_deleted = FALSE
        <if test="keyword != null and keyword != ''">
            AND (
            p.title LIKE CONCAT('%', #{keyword}, '%')
            OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
            OR sh.ceo_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        GROUP BY p.id, p.title, p.created_at, u.user_name, sh.ceo_name, r.name, p.view
        ORDER BY p.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 조회수 기준 인기 게시글 -->
    <select id="selectAllMissingPostsByView" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT
            p.id              AS id,         -- 번호
            p.title           AS title,      -- 제목
            p.created_at      AS createdAt,  -- 작성일
            p.view            AS view,       -- 조회수
            r.name      AS userRating, -- 사용자 등급
        COALESCE(u.user_name, sh.ceo_name) AS userName,  -- 작성자 이름
        IFNULL(COUNT(mpl.id), 0) AS likeCount  ,          -- 추천수
         p.status
        FROM missingPost p
            LEFT JOIN user u ON p.user_id = u.user_id
            LEFT JOIN shelter_head sh ON p.head_id = sh.head_id
            LEFT JOIN rating r ON u.rating_id = r.id
            LEFT JOIN missingPostLiked mpl ON p.id = mpl.post_id
        WHERE p.is_deleted = FALSE
        GROUP BY p.id, p.title, p.created_at, u.user_name, sh.ceo_name, r.name, p.view
        ORDER BY p.view DESC
            LIMIT #{limit};
    </select>

    <!--추천수 기준 인기 게시글 -->
    <select id="selectAllMissingPostsByLiked" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT
            p.id              AS id,        -- 번호
            p.title           AS title,     -- 제목
            p.created_at      AS createdAt, -- 작성일
            p.view            AS view,      -- 조회수
            r.name      AS userRating, -- 사용자 등급
        COALESCE(u.user_name, sh.ceo_name) AS userName, -- 작성자 이름
        IFNULL(COUNT(mpl.id), 0) AS likeCount   ,        -- 추천수
         p.status
        FROM missingPost p
            LEFT JOIN user u ON p.user_id = u.user_id
            LEFT JOIN shelter_head sh ON p.head_id = sh.head_id
            LEFT JOIN missingPostLiked mpl ON p.id = mpl.post_id
            LEFT JOIN rating r ON u.rating_id = r.id
        WHERE p.is_deleted = FALSE
        GROUP BY p.id, p.title, p.created_at, u.user_name, sh.ceo_name, r.name, p.view
        ORDER BY likeCount DESC
            LIMIT #{limit}
    </select>

    <!-- 최신 게시글 -->
    <select id="selectAllMissingPostsLatest" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT
            p.id              AS id,        -- 번호
            p.title           AS title,     -- 제목
            p.created_at      AS createdAt, -- 작성일
            p.view            AS view,      -- 조회수
            r.name      AS userRating, -- 사용자 등급
        COALESCE(u.user_name, sh.ceo_name) AS userName, -- 작성자 이름
        IFNULL(COUNT(mpl.id), 0) AS likeCount,           -- 추천수
         p.status
        FROM missingPost p
            LEFT JOIN user u ON p.user_id = u.user_id
            LEFT JOIN shelter_head sh ON p.head_id = sh.head_id
            LEFT JOIN missingPostLiked mpl ON p.id = mpl.post_id
            LEFT JOIN rating r ON u.rating_id = r.id
        WHERE p.is_deleted = FALSE
        GROUP BY p.id, p.title, p.created_at, u.user_name, sh.ceo_name, r.name, p.view
        ORDER BY p.created_at DESC
            LIMIT #{limit}
    </select>


    <!--게시판보드, 게시글 목록 조회 쿼리-->
    <select id="selectAllMissingPosts"
    resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT
        p.id              AS id,        -- 번호
        p.title           AS title,     -- 제목
        p.created_at      AS createdAt, -- 작성일
        p.view            AS view,      -- 조회수
        r.name      AS userRating, -- 사용자 등급
        COALESCE(u.user_name, sh.ceo_name) AS userName, -- 작성자 이름 (회원/보호소장)
        IFNULL(COUNT(mpl.id), 0) AS likeCount ,          -- 추천수
         p.status
        FROM missingPost p
        LEFT JOIN user u ON p.user_id = u.user_id
        LEFT JOIN shelter_head sh ON p.head_id = sh.head_id
        LEFT JOIN missingPostLiked mpl ON p.id = mpl.post_id
            LEFT JOIN rating r ON u.rating_id = r.id
        WHERE p.is_deleted = FALSE
        GROUP BY p.id, p.title, p.created_at, u.user_name, sh.ceo_name, r.name, p.view
        ORDER BY p.id DESC
    </select>


    <!--조회수 증가 -->
    <update id="increaseView">
        UPDATE missingPost
        SET view = view + 1
        WHERE id = #{id}
    </update>


    <!-- 실종신고 게시글 내용 상세 조회 -->
    <select id="selectMissingPostDetail"
            parameterType="int"
            resultMap="MissingPostDetailResultMap">
        SELECT
            p.id               AS post_id,             -- 게시글 번호
            p.title            AS post_title,          -- 제목
            p.content          AS post_content,        -- 내용
            p.created_at       AS post_created_at,     -- 작성일
            r.name             AS post_user_rating, -- 사용자 등급
            u.user_name        AS post_user_name,      -- 작성자 이름
            p.view             AS post_view,           -- 조회수
            IFNULL(l.like_count, 0) AS post_like_count,-- 추천 수
            f.id AS file_id,
            f.file_rename AS file_rename,
            p.status           AS post_status,         -- 실종 상태
            p.detail_address   AS post_detail_address, -- 상세 위치
            p.gender           AS post_gender,         -- 성별
            p.age              AS post_age,            -- 나이
            p.registration_num AS post_registration_num,-- 등록번호
            p.breed            AS post_breed,          -- 품종
            p.animal_type      AS post_animal_type,    -- 동물 구분
            p.color            AS post_color,          -- 색상
            p.weight           AS post_weight,         -- 체중
            p.lost_date        AS post_lost_date,      -- 실종일자
            p.feature          AS post_feature,        -- 특징
            p.contact          AS post_contact         -- 연락처
        FROM missingPost p
                 LEFT JOIN user u ON p.user_id = u.user_id
                 LEFT JOIN rating r ON u.rating_id = r.id
                 LEFT JOIN (
            SELECT post_id, COUNT(*) AS like_count
            FROM missingPostLiked
            GROUP BY post_id
        ) l ON p.id = l.post_id
       LEFT JOIN missingPostFiles f ON p.id = f.post_id
        WHERE p.id = #{id}
          AND p.is_deleted = FALSE
    </select>

        <!-- 실종신고 게시글 하나 안에서  -->
    <resultMap id="MissingPostDetailResultMap"
               type="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDetailDTO">
        <id property="id" column="post_id"/>
        <result property="title" column="post_title"/>
        <result property="content" column="post_content"/>
        <result property="createdAt" column="post_created_at"/>
        <result property="userRating" column="post_user_rating"/>
        <result property="userName" column="post_user_name"/>
        <result property="view" column="post_view"/>
        <result property="likeCount" column="post_like_count"/>

        <!-- 실종신고 게시글 하나 안에서 동물 관련 정보 -->
        <result property="status" column="post_status"/>
        <result property="detailAddress" column="post_detail_address"/>
        <result property="gender" column="post_gender"/>
        <result property="age" column="post_age"/>
        <result property="registrationNum" column="post_registration_num"/>
        <result property="breed" column="post_breed"/>
        <result property="animalType" column="post_animal_type"/>
        <result property="color" column="post_color"/>
        <result property="weight" column="post_weight"/>
        <result property="lostDate" column="post_lost_date"/>
        <result property="feature" column="post_feature"/>
        <result property="contact" column="post_contact"/>


        <!-- 파일 리스트 -->
        <collection property="files"
                    ofType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostFileDTO">
            <id property="id" column="file_id"/>
            <result property="fileRename" column="file_rename"/>
        </collection>
    </resultMap>


    <!-- 댓글 목록 (페이징) -->
        <select id="selectMissingPostDetailComments" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostCommentDTO">
            SELECT
                c.id,
                c.content,
                c.created_at AS createdAt,
                r.name AS userRating, -- 사용자 등급
                COALESCE(u.user_name, sh.ceo_name) AS userName -- 작성자 이름 (회원/보호소장)
            FROM missingPostComment c
                     LEFT JOIN user u ON c.user_id = u.user_id
                     LEFT JOIN rating r ON u.rating_id = r.id
                     LEFT JOIN shelter_head sh ON c.head_id = sh.head_id
            WHERE c.post_id = #{postId}
              AND c.is_deleted = FALSE
            ORDER BY c.created_at ASC
                LIMIT #{limit} OFFSET #{offset}
        </select>

        <!-- 댓글 총 개수 -->
        <select id="countComments" resultType="int">
            SELECT COUNT(*)
            FROM missingPostComment
            WHERE post_id = #{postId}
              AND is_deleted = FALSE
        </select>

</mapper>